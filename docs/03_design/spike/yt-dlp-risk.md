# リスク評価 – yt-dlp 利用  
Date: 2025-07-29  
Status: Draft  

## 背景  
MVP α では YouTube URL から音声ストリームを取得し譜面生成・再生を行う。一般的に `yt-dlp` が用いられるが、Google 利用規約および GPLv3 ライセンス、著作権法への適合を確認する必要がある。  

## リスク一覧  
| # | リスク | 影響 | 発生確率 | 影響度 | 優先度 | Mitigation |
|---|--------|------|---------|-------|-------|------------|
| R1 | YouTube 規約違反（自動 DL 禁止） | API キー停止・法的要求 | 高 | 高 | ★★★ | A3 POC + 法務確認 (#1, #2) |
| R2 | googleapis 公式 API へ移行コスト | 実装遅延 | 中 | 中 | ★★ | A2, A3 の比較検討 |
| R3 | GPLv3 伝播義務 | ソース公開/コンプライアンス負荷 | 低 | 高 | ★★ | サービス分離・MIT代替 (#3) |
| R4 | yt-dlp メンテ停止/仕様変更 | サービス停止 | 中 | 中 | ★★ | Serverless化・代替案検討 (#1, #3) |

## 代替案評価  
| 案 | 概要 | 長所 | 短所 | 採否 |
|----|------|------|------|------|
| A1 | yt-dlp 直接呼び出し | 実装容易 | 規約グレー／GPLv3 | 保留 |
| A2 | YouTube Data API + embed 再生 | 規約準拠 | 音声抽出不可 | 不採用 |
| A3 | Serverless で yt-dlp 隔離 | GPL 伝播回避・本体と分離 | コスト増 | 要検証 |

---

## ストリーミング限定案の検討
YouTube 公式 iframe / embed API でブラウザ再生し、WebAudio で MediaElement から
PCM を取得する方法を検証したが、**CORS 制約により `AudioContext.createMediaElementSource`
で跨域音声のバッファ取得はブロックされる**。したがって譜面生成アルゴリズムに
必要なスペクトラム・BPM 解析用のサンプルデータが取得できず、以下の課題が残る。

| 課題 | 詳細 |
|------|------|
| 音声バッファ取得不可 | Same-Origin 制限で getChannelData 参照が拒否される |
| 解析タイミング遅延 | ストリームはリアルタイムでしか受信できず、5 分曲では ≥5 分待機 |
| シード一貫性 | ストリーム品質変動で譜面生成が再現不能 |

結論として、**ストリーミングのみでは US-001 の「300 秒以内に譜面生成」要件を満たせない**。
最低限、音声トラックをバイト列として一時保存（全長または先頭 N 秒）し、
サーバまたは WASM でオフライン解析する処理が不可欠。

### 推奨
- yt-dlp/DASH API を用いて **音声のみの 128-192kbps WebM トラックを先頭 120 秒取得**
  （約3-4 MB）→ 解析 → 破棄
- これを「技術的にはダウンロードだが一時キャッシュに留め、著作権法的私的複製に該当」
  するかを法務確認。

## 推奨アクション  
1. Spike: A3 POC (`docs/03_design/spike/yt-dlp-serverless.md`) を作成し性能/コスト評価  
2. 法務 & PO と規約確認 (非営利利用含む)  
3. GPLv3 伝播回避策の検討（独立サービス or MIT 代替ツール探索）  