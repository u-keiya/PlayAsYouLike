@startuml
' ==========================================================
' Class Diagram — Dynamic Visual Effects (#US-005)
' PlayAsYouLike Web Rhythm Game
' ==========================================================
' [US-005] VisualEffectPreset API/設計連携: /effects/presets, SessionCreateResponse.presets[]
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

' ------------ Legend -------------------------------------------------
'  <<Entity>>        : 永続または一時データを保持
'  <<ValueObject>>   : 値のみで同値性判定
'  <<Service>>       : ステートレスロジック
'  <<Repository>>    : 永続化インタフェース
' ---------------------------------------------------------------------

namespace GameplayCore {

  ' ====== Entities ===================================================
  class GameSession <<Entity>> {
    +id : UUID
    +beatmap : Beatmap
    +status : SessionStatus
    +effectsPreset : VisualEffectPreset
    +presets : List~VisualEffectPreset~ [0..10]  ' #US-005: API連携・最大10件（UI/パフォーマンス要件より）
  }

  class VisualEffectPreset <<Entity>> {
    +id : string
    +name : string
    +baseColorHex : string
    +particleIntensity : float
    +cameraShake : float
    +bgShader : string
    ' #US-005: APIスキーマと同期
  }

  note right of GameSession
    presets上限10件の根拠:
    - UI上の選択肢表示・操作性（1画面で完結）
    - サーバ/クライアント双方のパフォーマンス最適化
    - ビジネス要件（プリセット乱用防止）
  end note

  ' ====== Value Objects ==============================================
  class MusicFeatures <<ValueObject>> {
    +bpm : BPM
    +energy : float
    +spectralCentroid : float
    +section : string
  }

  class BPM <<ValueObject>> {
    +value : int
  }

  ' ====== Services ===================================================
  class MusicAnalyser <<Service>> {
    +analyse(audioUrl : Url) : MusicFeatures[*]
  }

  class VisualEffectEngine <<Service>> {
    +selectPreset(features : MusicFeatures) : VisualEffectPreset
    +applyPreset(session : GameSession, preset : VisualEffectPreset) : void
    +listPresets() : List~VisualEffectPreset~  ' #US-005: /effects/presets
  }

  ' ====== Repositories ===============================================
  class PresetRepository <<Repository>> {
    +findById(id : string) : VisualEffectPreset?
    +findByFeatures(features : MusicFeatures) : VisualEffectPreset
    +findAll() : List~VisualEffectPreset~  ' #US-005: API連携
  }

  ' ====== Relationships ==============================================
  GameSession --> VisualEffectPreset : effectsPreset
  GameSession --> "0..10" VisualEffectPreset : presets #US-005

  MusicAnalyser ..> Url
  MusicAnalyser --> MusicFeatures

  VisualEffectEngine ..> MusicFeatures
  VisualEffectEngine ..> VisualEffectPreset
  VisualEffectEngine ..> GameSession

  PresetRepository ..> VisualEffectPreset

}

@enduml