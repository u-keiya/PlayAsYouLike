@startuml
' ==============================================================
' Sequence Diagram — Dynamic Visual Effects (#US-002)
' ==============================================================
actor User as user <<Persona>>
participant "Web SPA\n(React)"            as spa
participant "Backend API\nFastify"        as api
database    "Redis\nSession Cache"        as cache
participant "MusicAnalyser\n(Service)"    as analyser
participant "VisualEffectEngine\n(Service)" as engine

== プレイ開始後 ==
spa -> analyser : WebSocket stream /audio\n(audioUrl)
analyser --> engine : MusicFeatures (BPM, energy, section ...)
engine -> cache : GET presets:byFeatures
cache --> engine : VisualEffectPreset
engine -> spa : push /ws/effectPreset {presetId, params}

loop ~1s interval (変化検知)
  analyser --> engine : MusicFeaturesΔ
  alt latency ≤ 200 ms
    engine -> cache : GET/Find Preset
    engine --> spa : push newPreset (within 1 s)  # US-005 SLA
  else latency > 200 ms  ' #RQ02-3
    spa -> engine : GET /api/effect/sync?clientTime=...
    engine -> analyser : requestCurrentPosition()
    engine --> spa : push /ws/effectPreset (correctedOffset)
  end
end

== プレイ終了 ==
spa -> engine : unsubscribe
@enduml