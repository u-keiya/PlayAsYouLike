@startuml
' ==============================================================
' Sequence Diagram — Real-time Hit Judge via WebSocket (#US-001, #US-002)
' ==============================================================
actor User  as user <<Persona>>
participant "Web SPA\n(React)"            as spa
participant "Backend API\nFastify"        as api
participant "HitJudge\n(Service)"         as judge

== プレイ中リアルタイム判定 ==

user -> spa : キー押下（タイミング入力）
spa -[#blue]-> api : WebSocket: send PlayerInput
api -> judge : judge(input, note)
judge --> api : HitResult
alt judgeLag ≤ 200 ms
  api -[#green]-> spa : WebSocket: push HitResult
  spa -> user : フィードバック表示（エフェクト・音）
else judgeLag > 200 ms <<#RQ03-2>>
  api -[#orange]-> spa : WebSocket: push Warning(type="lag", threshold=200)  ' ERR-JUDGE-LAG
  spa -> user : UI flash "Too Late!"
end

== エラー・切断時 ==
spa -[#red]-> api : WebSocket: close/timeout
api -> spa : エラー通知（option）

@enduml